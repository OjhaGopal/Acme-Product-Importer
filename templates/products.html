{% extends "base.html" %}

{% block title %}Products - Acme Product Importer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Product Management</h2>
    <div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProductModal">Add Product</button>
        <button class="btn btn-danger" onclick="deleteAllProducts()">Delete All Products</button>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" class="form-control" id="searchInput" placeholder="Search products...">
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="true">Active</option>
            <option value="false">Inactive</option>
        </select>
    </div>
    <div class="col-md-3">
        <button class="btn btn-primary" onclick="loadProducts()">Search</button>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <span id="productCount">Loading product count...</span>
            <small class="text-muted">Total products in database</small>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div id="productsTable">Loading products...</div>
        
        <nav aria-label="Products pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-control" name="sku" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="active" checked>
                            <label class="form-check-label">Active</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm">
                <input type="hidden" name="id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-control" name="sku" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="active">
                            <label class="form-check-label">Active</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Product</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 0;
const pageSize = 20;

async function loadProducts(page = 0) {
    const search = document.getElementById('searchInput').value;
    const status = document.getElementById('statusFilter').value;
    
    const params = new URLSearchParams({
        skip: page * pageSize,
        limit: pageSize
    });
    
    if (search) params.append('search', search);
    if (status) params.append('active', status);

    try {
        const [productsResponse, countResponse] = await Promise.all([
            fetch(`/api/products?${params}`),
            fetch(`/api/products/count?${params}`)
        ]);

        const products = await productsResponse.json();
        const countData = await countResponse.json();

        displayProducts(products);
        displayPagination(countData.count, page);
        updateProductCount(countData.count, search, status);
        currentPage = page;
    } catch (error) {
        document.getElementById('productsTable').innerHTML = '<p class="text-danger">Error loading products</p>';
    }
}

function displayProducts(products) {
    if (products.length === 0) {
        document.getElementById('productsTable').innerHTML = '<p class="text-muted">No products found</p>';
        return;
    }

    const table = `
        <table class="table table-striped">
            <thead>
                <tr>
                    <th style="width: 25%">Name</th>
                    <th style="width: 15%">SKU</th>
                    <th style="width: 30%">Description</th>
                    <th style="width: 10%">Status</th>
                    <th style="width: 20%">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${products.map(product => `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.sku}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${product.description || ''}">${product.description || ''}</td>
                        <td>
                            <span class="badge ${product.active ? 'bg-success' : 'bg-secondary'}">
                                ${product.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-${product.active ? 'warning' : 'success'}" 
                                        onclick="toggleProductStatus(${product.id})" 
                                        title="${product.active ? 'Deactivate' : 'Activate'}">
                                    <i class="fas fa-${product.active ? 'pause' : 'play'}"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editProduct(${product.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    document.getElementById('productsTable').innerHTML = table;
}

function displayPagination(totalCount, currentPage) {
    const totalPages = Math.ceil(totalCount / pageSize);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';
    
    // Previous button
    html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadProducts(${currentPage - 1})">Previous</a>
    </li>`;
    
    // Page numbers
    for (let i = 0; i < totalPages; i++) {
        if (i === currentPage || i === 0 || i === totalPages - 1 || Math.abs(i - currentPage) <= 2) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadProducts(${i})">${i + 1}</a>
            </li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Next button
    html += `<li class="page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadProducts(${currentPage + 1})">Next</a>
    </li>`;
    
    pagination.innerHTML = html;
}

// Form handlers
document.getElementById('addProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    try {
        const response = await fetch('/api/products', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            e.target.reset();
            loadProducts(currentPage);
            alert('Product added successfully');
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error adding product');
    }
});

document.getElementById('editProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const id = formData.get('id');
    try {
        const response = await fetch(`/api/products/${id}`, {
            method: 'PUT',
            body: formData
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            loadProducts(currentPage);
            alert('Product updated successfully');
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error updating product');
    }
});

async function editProduct(id) {
    try {
        const response = await fetch(`/api/products?skip=0&limit=1000`);
        const products = await response.json();
        const product = products.find(p => p.id === id);
        
        if (product) {
            const form = document.getElementById('editProductForm');
            form.querySelector('[name="id"]').value = product.id;
            form.querySelector('[name="name"]').value = product.name;
            form.querySelector('[name="sku"]').value = product.sku;
            form.querySelector('[name="description"]').value = product.description || '';
            form.querySelector('[name="active"]').checked = product.active;
            
            new bootstrap.Modal(document.getElementById('editProductModal')).show();
        }
    } catch (error) {
        alert('Error loading product details');
    }
}

async function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;

    try {
        const response = await fetch(`/api/products/${id}`, {method: 'DELETE'});
        
        if (response.ok) {
            loadProducts(currentPage);
            alert('Product deleted successfully');
        } else {
            alert('Error deleting product');
        }
    } catch (error) {
        alert('Error deleting product');
    }
}

async function deleteAllProducts() {
    if (!confirm('Are you sure you want to delete ALL products? This cannot be undone.')) return;

    try {
        const response = await fetch('/api/products', {method: 'DELETE'});
        
        if (response.ok) {
            loadProducts(0);
            alert('All products deleted successfully');
        } else {
            alert('Error deleting products');
        }
    } catch (error) {
        alert('Error deleting products');
    }
}

// Search on Enter key
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        loadProducts(0);
    }
});

async function toggleProductStatus(id) {
    try {
        const response = await fetch(`/api/products/${id}/toggle-status`, {
            method: 'PUT'
        });
        
        if (response.ok) {
            const result = await response.json();
            loadProducts(currentPage);
            showToast(result.message, 'success');
        } else {
            showToast('Error updating product status', 'danger');
        }
    } catch (error) {
        showToast('Error updating product status', 'danger');
    }
}

function updateProductCount(count, search, status) {
    let countText = `${count} products`;
    
    if (search || status) {
        countText += ' (filtered)';
    }
    
    if (search) {
        countText += ` matching "${search}"`;
    }
    
    if (status) {
        countText += ` - ${status === 'true' ? 'Active' : 'Inactive'} only`;
    }
    
    document.getElementById('productCount').textContent = countText;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Load products on page load
loadProducts();
</script>
{% endblock %}